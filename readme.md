## Historic reference streamflow data analysis

### Data prep

To prepare historic reference data for analysis, the periods of record were first assessed and extended to the present or through the past (if data were collected for a starting year later than the beginning of recording). A summary of this process is included in the POR Extension readme .docx file. All resulting streamflow data was processed with the functional flows calculator using the default parameters for each gage's streamflow class, resulting in annual functional flow metrics for each gage. These annual functional flow metrics were inputted to the anlayses in this repository for further processing. 

## Mann-Kendall trend analysis

This statistical test was chosen as one of the most common nonparametric tests to detect monotonic (single direction) change over time, using a simple tallying of up or down stepwise increments across a timeseries. The process described here is coded in the trends.py file. Individual metric timeseries from each gage were run through the analysis one at a time, for 223 gages * 28 metrics = 6244 trend calculations. I used a Mann Kendall calculator described by Hussian et al. 2019, which provides the test decision (up trend, down trend, or no trend), the p-value significance (set to p less than 0.05), and the Sen slope of the trend, calculated as the median of stepwise slopes across the timeseries. I added a calculation to determine the accompanying intercept of the Theil Robust line. The Theil Robust line, which serves as an outliers-robust regression line, was used to calculate the residuals of the predicted verses observed data. The resulting residuals were then tested for the presence of autocorrelation using the Ljung-Box statistical test. This test is important because an assumption of the Mann-Kendall test is that there is no autocorrelation/seasonal effects in the timeseries. In this case, a p-value less than 0.05 means that the residuals *do* experience autocorrelation, which means the input data must be further processed to remove seasonal effects before the Mann-Kendall analysis can be used appropriately. Ideally, residuals that do not experience auctocorrelation have a "white noise" appearance and show no sign of patterns. Out of the input 6244 timeseries of flow metrics, only 107 timeseries tested significant for the Ljung-Box test, indicating autocorrelation. This is as expected because flow metrics are calculated on an annual basis and are largely affected by water year type, which generally does not exhibit trends over decadal or longer timescales. 

To correct for autocorrelation, an iterative differencing method was used similar to the procedure outlined in Abdulhafedh 2017. Starting with a lag of 1, the input time series is differenced, and the resulting transformed data is again tested with Mann Kendall and the Ljung-Box tests. If the p-value of the residuals is still significant, indicating autocorrelation, the process is repeated with an incrementally-increased lag until autocorrelation is eliminated. This procedure only needed to be performed on less than 2% of the dataset, and was usually resolved with 1-2 lags of differencing, although the largest lag needed was 27. Five metric timeseries out of the 6244 could not be corrected because their timeseries was too short to be transformed with differencing, and therefore did not have the Man-Kendall trend calculated. 
