## Historic reference streamflow data analysis

### Data prep

To prepare historic reference data for analysis, the periods of record were first assessed and extended to the present or through the past (if data were collected for a starting year later than the beginning of recording). A summary of this process is included in the POR Extension readme .docx file. All resulting streamflow data was processed with the functional flows calculator using the default parameters for each gage's streamflow class, resulting in annual functional flow metrics for each gage. One modification was made to the functional flow metrics so that the peak magnitude metrics would report the annual peak flow value, instead of the highflow percentile across the period of record. This change would allow actual peak flow trends across the period of record to be detected, if present. The annual functional flow metrics are stored in the 'data_inputs' folder of this repository for further analysis. 

## Mann-Kendall trend analysis

Trend analyses were performed on a subset of the 223 gages that had sufficient length periods of record for trend detection, with ending years close enough to present to expect trends due to recent climate change. POR's of 40 years or less were removed from analysis, and well as POR's ending before 2005. This limited the gages for trend analysis from 223 to 72.  

This statistical test was chosen as one of the most common nonparametric tests to detect monotonic (single direction) change over time, using a simple tallying of up or down stepwise increments across a timeseries. The process described here is coded in the trends.py file. Individual metric timeseries from each gage were run through the analysis one at a time, for 72 gages * 28 metrics = 2016 trend calculations. I used a Mann Kendall calculator described by Hussian et al. 2019, which provides the test decision (up trend, down trend, or no trend), the p-value significance (set to p less than 0.05), and the Sen slope of the trend, calculated as the median of stepwise slopes across the timeseries. I added a calculation to determine the accompanying intercept of the Theil Robust line. The Theil Robust line, which serves as an outliers-robust regression line, was used to calculate the residuals of the predicted verses observed data. The resulting residuals were then tested for the presence of autocorrelation using the Ljung-Box statistical test. This test is important because an assumption of the Mann-Kendall test is that there is no autocorrelation/seasonal effects in the timeseries. In this case, a p-value less than 0.05 means that the residuals *do* experience autocorrelation, which means the input data must be further processed to remove seasonal effects before the Mann-Kendall analysis can be used appropriately. Ideally, residuals that do not experience auctocorrelation have a "white noise" appearance and show no sign of patterns. Out of the input 2016 timeseries of flow metrics, only 173 timeseries tested significant for the Ljung-Box test, indicating autocorrelation. This is as expected because flow metrics are calculated on an annual basis and are largely affected by water year type, which generally does not exhibit trends over decadal or longer timescales. 

To correct for autocorrelation, an iterative differencing method was used similar to the procedure outlined in Abdulhafedh 2017. Starting with a lag of 1, the input time series is differenced, and the resulting transformed data is again tested with Mann Kendall and the Ljung-Box tests. If the p-value of the residuals is still significant, indicating autocorrelation, the process is repeated with an incrementally-increased lag until autocorrelation is eliminated. This procedure  needed to be performed on 8.5% of the dataset, and was usually resolved with a few lags of differencing, although the largest lag needed was 32. 
